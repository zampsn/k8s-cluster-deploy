on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_TOKEN }}

      - name: Install Kubectl
        uses: azure/setup-kubectl@v3

      - name: Install Helm
        uses: azure/setup-helm@v3

      - name: Save kubeconfig
        run: doctl kubernetes cluster kubeconfig save main

      - name: Deploy Nginx ingress controller
        run: |
          helm upgrade --install ingress-nginx ingress-nginx \
            --repo https://kubernetes.github.io/ingress-nginx \
            --namespace ingress-nginx --create-namespace \
            --set controller.replicaCount=2 \
            --set fullnameOverride=nginx

      - name: Deploy hello world app
        run: |
          helm upgrade --install hello-world ./docker-helm \
            --namespace sandbox --create-namespace \
            -f ./resources/hello-world/values.yaml

      - name: Deploy Authentik
        run: |
          helm upgrade --install authentik authentik \
            --repo https://charts.goauthentik.io \
            --namespace authentik --create-namespace \
            --set authentik.secret_key=${{ secrets.AUTHENTIK_SECRET_KEY }} \
            --set authentik.postgres.password=${{ secrets.AUTHENTIK_POSTGRES_PASSWORD }} \
            --set postgres.auth.password=${{ secrets.AUTHENTIK_POSTGRES_PASSWORD }} \
            -f ./resources/authentik/values.yaml 
